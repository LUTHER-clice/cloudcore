<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudCore - Sign In</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:,">
</head>
<body>
<div class="login-container">
    <div class="language-switcher">
        <button class="language-btn" id="languageBtn" onclick="switchLanguage()" title="Switch language">
            <span class="language-flag" id="langFlag">üåê</span>
            <span class="language-code" id="langCode">EN</span>
        </button>
    </div>
    <h1>‚òÅÔ∏è CloudCore</h1>

    <div id="error-message" class="error" style="display: none;"></div>
    <div id="success-message" class="success" style="display: none;"></div>

    <form class="login-form" id="loginForm">
        <div class="form-group">
            <label for="username" data-i18n="username">Username</label>
            <input type="text" id="username" name="username">
        </div>

        <div class="form-group">
            <label for="password" data-i18n="password">Password</label>
            <input type="password" id="password" name="password" >
        </div>

        <button type="submit" class="btn btn-primary" id="loginBtn" data-i18n="signIn">Sign In</button>
    </form>
    

    <div class="login-link"><span data-i18n="noAccount">Don't have an account? </span>
        <a href="register.html" data-i18n="createAccount">Create account</a>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:5000';
    let currentLanguage = localStorage.getItem('cloudcore-language') || 'en';

    // Translation object
    const translations = {
        en: {
            title: 'CloudCore - Sign In',
            username: 'Username',
            password: 'Password',
            signIn: 'Sign In',
            signingIn: 'Signing in...',
            noAccount: "Don't have an account?",
            createAccount: 'Create account',
            welcomeBack: 'Welcome back, {username}!',
            signInFailed: 'Sign in failed. Please check your credentials.',
            connectionError: 'Unable to connect to server. Please try again.',
            loginSuccessful: 'üéâ Login successful!',
            invalidCredentials: 'Invalid username or password'
        },
        uk: {
            title: 'CloudCore - –í—Ö—ñ–¥',
            username: '–Ü–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞',
            password: '–ü–∞—Ä–æ–ª—å',
            signIn: '–£–≤—ñ–π—Ç–∏',
            signingIn: '–í—Ö–æ–¥–∂—É...',
            noAccount: '–ù–µ–º–∞—î –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É?',
            createAccount: '–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å',
            welcomeBack: '–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º, {username}!',
            signInFailed: '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–≤–æ—ó –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ.',
            connectionError: '–ù–µ–º–æ–∂–ª–∏–≤–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.',
            loginSuccessful: 'üéâ –£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥!',
            invalidCredentials: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ —ñ–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ –ø–∞—Ä–æ–ª—å'
        }
    };

    function t(key) {
        return translations[currentLanguage][key] || key;
    }

    // Language switching function - exactly like in main system
    function switchLanguage() {
        currentLanguage = currentLanguage === 'en' ? 'uk' : 'en';
        localStorage.setItem('cloudcore-language', currentLanguage);
        updateLanguageButton();
        updateUILanguage();
    }

    // Update language button display - same as main system
    function updateLanguageButton() {
        const btn = document.getElementById('languageBtn');
        const flag = btn.querySelector('.language-flag');
        const code = btn.querySelector('.language-code');
        
        if (currentLanguage === 'uk') {
            flag.textContent = 'üá∫üá¶';
            code.textContent = 'UA';
            btn.title = '[translate:–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –º–æ–≤—É]';
        } else {
            flag.textContent = 'üåê';
            code.textContent = 'EN';
            btn.title = 'Switch language';
        }
    }

    // Update UI language - using data-i18n pattern like main system
    function updateUILanguage() {
        document.title = currentLanguage === 'uk' ? 'CloudCore - –í—Ö—ñ–¥' : 'CloudCore - Sign In';
        
        // Update all elements with data-i18n attributes
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[currentLanguage][key]) {
                element.textContent = translations[currentLanguage][key];
            }
        });
    }

    // Auto-fill demo credentials
    function fillCredentials(username, password) {
        document.getElementById('username').value = username;
        document.getElementById('password').value = password;
    }

    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('success-message').style.display = 'none';
    }

    // Show success message
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('error-message').style.display = 'none';
    }

    // Hide all messages
    function hideMessages() {
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';
    }

    // Handle login form submission
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginBtn = document.getElementById('loginBtn');

        // Disable button and show loading
        loginBtn.disabled = true;
        loginBtn.textContent = t('signingIn');
        hideMessages();

        try {
            const response = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('cloudcore_token', data.token);
                localStorage.setItem('cloudcore_user', JSON.stringify({
                    id: data.userId,
                    username: data.username,
                    email: data.email
                }));

                console.log('üéâ Login successful!');
                console.log('JWT Token:', data.token);
                console.log('User Info:', data);

                showSuccess(t('welcomeBack').replace('{username}', data.username));

                // Redirect to main page after 1 second
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);

            } else {
                // Login failed
                let errorMessage = t('signInFailed'); // default message
                
                if (data.message) {
                    // Check if the server error matches the known invalid credentials message
                    if (data.message.toLowerCase().includes('invalid username or password') ||
                        data.message.toLowerCase().includes('invalid credentials')) {
                        errorMessage = t('invalidCredentials');
                    } else {
                        errorMessage = data.message; // Use server message if available
                    }
                }
                
                showError(errorMessage);
            }

        } catch (error) {
            console.error('Login error:', error);
            showError(t('connectionError'));
        } finally {
            // Re-enable button
            loginBtn.disabled = false;
            loginBtn.textContent = t('signIn');
        }
    });

    // Check if user is already logged in
    window.addEventListener('load', function() {
        const token = localStorage.getItem('cloudcore_token');
        if (token) {
            console.log('User already logged in, redirecting...');
            window.location.href = 'index.html';
            return;
        }

        // Initialize language system
        updateLanguageButton();
        updateUILanguage();
    });
</script>
</body>
</html>